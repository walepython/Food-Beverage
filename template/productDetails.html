{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Details{% endblock %}
{% block body %}

<link rel="stylesheet" href="{% static 'assets/css/templatemo-sixteen2.css' %}">
<div class="product-detail-container">

    <!-- Left Side: Product Image Gallery -->
    <div class="product-gallery">
        <div class="main-image">
            {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}">
            {% else %}
                <img src="{% static 'assets/images/product_01.jpg' %}" alt="Placeholder Image">
            {% endif %}
            <!-- Gallery navigation arrows -->
            <button class="gallery-nav prev">&lt;</button>
            <button class="gallery-nav next">&gt;</button>
        </div>
        <!-- You can add thumbnail images here if you have a multi-image model -->
    </div>

    <!-- Right Side: Product Information -->
    <div class="product-info">
        <!-- Category and Share Button -->
        <div class="info-header">
            <span class="category">{{ product.category }}</span>
            <button class="share-button">
                <i class="fa fa-share-alt"></i> <!-- Font Awesome share icon -->
            </button>
        </div>

        <!-- Product Title -->
        <h3 class="share-button1">{{ product.sub_category }}</h3>
        <h1 class="product-title">{{ product.name }}</h1>

        <!-- Rating and Reviews -->
        <div class="product-rating">
            <div class="stars">
                <!-- Logic to generate stars based on 'average_rating' -->
                <i class="fa fa-star"></i>
                <i class="fa fa-star"></i>
                <i class="fa fa-star"></i>
                <i class="fa fa-star"></i>
                <i class="fa fa-star-half-alt"></i>
            </div>
            <span class="rating-value">{{ product.average_rating }}</span>
            <a href="#reviews" class="review-count">{{product.review_count }} Reviews</a>
        </div>

        <!-- Price Box -->
        <div class="price-box">
            <div class="price-line">
                <span id="product-price" class="current-price">
                    {% if product.price_choice == 'Per_paint' %}
                ₦{{ product.price_per_paint|floatformat:2 }}
            {% elif product.price_choice == 'Per_bag' %}
                ₦{{ product.price_per_bag|floatformat:2 }}
            {% elif product.price_choice == 'Per_tuba' %}
                ₦{{ product.price_per_tuba|floatformat:2 }}
            {% elif product.price_choice == 'Per_pack' %}
                ₦{{ product.price_per_pack|floatformat:2 }}
            {% else %}
                ₦{{ product.price_per_bag|floatformat:2 }}
            {% endif %}
                </span>
                <!-- Show old price based on current price_choice -->
                {% if product.price_choice == 'Per_paint' and product.old_per_paint and product.old_per_paint > product.price_per_paint %}
            <span class="old-price">₦{{ product.old_per_paint|floatformat:2 }}</span>
        {% elif product.price_choice == 'Per_bag' and product.old_per_bag and product.old_per_bag > product.price_per_bag %}
            <span class="old-price">₦{{ product.old_per_bag|floatformat:2 }}</span>
        {% elif product.price_choice == 'Per_tuba' and product.old_per_tuba and product.old_per_tuba > product.price_per_tuba %}
            <span class="old-price">₦{{ product.old_per_tuba|floatformat:2 }}</span>
        {% elif product.price_choice == 'Per_pack' and product.old_per_pack and product.old_per_pack > product.price_per_pack %}
            <span class="old-price">₦{{ product.old_per_pack|floatformat:2 }}</span>
        {% endif %}
            </div>

            <div class="stock-status">
                {% if product.stock_quantity > 0 %}
                    <i class="fa fa-check-circle in-stock"></i> In Stock
                    <span class="stock-count">({{ product.stock_quantity }} items left)</span>
                {% else %}
                    <i class="fa fa-times-circle out-of-stock"></i> Out of Stock
                {% endif %}
            </div>
        </div>

        <!-- Product Description -->
        <p class="product-description">{{ product.description|slice:":150" }}...</p>

        <!-- Package selector -->
        <div class="price-selector">
            <label for="price_choice">Choose Package:</label>
            <select
                id="price_choice"
                class="price-dropdown"
                data-price-bag="{{ product.price_per_bag|default:0 }}"
                data-price-paint="{{ product.price_per_paint|default:0 }}"
                data-price-tuba="{{ product.price_per_tuba|default:0 }}"
                data-price-pack="{{ product.price_per_pack|default:0 }}"
                data-old-price-bag="{{ product.old_per_bag|default:0 }}"
                data-old-price-paint="{{ product.old_per_paint|default:0 }}"
                data-old-price-tuba="{{ product.old_per_tuba|default:0 }}"
                data-old-price-pack="{{ product.old_per_pack|default:0 }}"
    >
                {% for value, label in price_options %}
                    <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        <!--Quantity Option-->
        <p class="qty">Quantity</p>
        <div class="quantity-selector">
            <button id="decrease" class="quantity-btn">−</button>
            <input id="quantity" type="text" class="quantity-input" value="1">
            <button id="increase" class="quantity-btn">+</button>
        </div>

        <!-- Add to Cart  -->
        <div class="cart-view1">
            <form method="POST" action="{% url 'add_to_cart' product.id %}">
                {% csrf_token %}
                <input type="hidden" name="price_choice" id="selected-package">
                <input type="hidden" name="selected_price" id="selected-price">
                <input type="hidden" name="quantity" id="selected-quantity" value="1">
                <button type="submit">Add to Cart</button>
            </form>
        </div>
    </div>

    <!-- Vendor Info -->
    {% if product.vendor %}
    <div class="vendor-box mt-5">
        <h3>Sold by: {{ product.vendor.username }}</h3>
        <p>Contact vendor for bulk or special orders.</p>
    </div>
    {% endif %}
</div>

<!-- "Back to Top" button -->
<button class="back-to-top" title="Go to top">↑</button>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const select = document.getElementById("price_choice");
    const priceDisplay = document.getElementById("product-price");
    const selectedPackageInput = document.getElementById("selected-package");
    const selectedPriceInput = document.getElementById("selected-price");
    const selectedQuantityInput = document.getElementById("selected-quantity");
    const quantityInput = document.getElementById("quantity");

    if (!select || !priceDisplay) {
        console.log('Required elements not found');
        return;
    }

    function updatePriceDisplay() {
        const value = select.value;
        console.log('Selected value:', value); // Debug log

        const priceMap = {
            Per_bag: select.dataset.priceBag,
            Per_paint: select.dataset.pricePaint,
            Per_tuba: select.dataset.priceTuba,
            Per_pack: select.dataset.pricePack
        };

        const oldPriceMap = {
            Per_bag: select.dataset.oldPriceBag,
            Per_paint: select.dataset.oldPricePaint,
            Per_tuba: select.dataset.oldPriceTuba,
            Per_pack: select.dataset.oldPricePack
        };

        const selectedPrice = priceMap[value];
        const selectedOldPrice = oldPriceMap[value];

        console.log('Price map:', priceMap); // Debug log
        console.log('Selected price:', selectedPrice); // Debug log

        if (selectedPrice && parseFloat(selectedPrice) > 0) {
            // Update current price display
            priceDisplay.textContent = `₦${parseFloat(selectedPrice).toFixed(2)}`;

            // Update hidden inputs
            if (selectedPackageInput) selectedPackageInput.value = value;
            if (selectedPriceInput) selectedPriceInput.value = selectedPrice;

            // Update old price display if exists
            const oldPriceElement = document.querySelector('.old-price');
            if (selectedOldPrice && parseFloat(selectedOldPrice) > 0 && parseFloat(selectedOldPrice) > parseFloat(selectedPrice)) {
                if (!oldPriceElement) {
                    // Create old price element if it doesn't exist
                    const oldPriceSpan = document.createElement('span');
                    oldPriceSpan.className = 'old-price';
                    oldPriceSpan.style.textDecoration = 'line-through';
                    oldPriceSpan.style.color = '#999';
                    oldPriceSpan.style.marginLeft = '10px';
                    oldPriceSpan.textContent = `₦${parseFloat(selectedOldPrice).toFixed(2)}`;
                    priceDisplay.parentNode.appendChild(oldPriceSpan);
                } else {
                    oldPriceElement.textContent = `₦${parseFloat(selectedOldPrice).toFixed(2)}`;
                }
            } else if (oldPriceElement) {
                // Remove old price if no discount
                oldPriceElement.remove();
            }

            // Update quantity input if needed
            if (selectedQuantityInput) selectedQuantityInput.value = quantityInput.value;
        } else {
            console.log('No valid price found for:', value);
        }
    }

    // Quantity buttons functionality
    document.getElementById("increase").addEventListener("click", function() {
        quantityInput.value = parseInt(quantityInput.value) + 1;
        if (selectedQuantityInput) selectedQuantityInput.value = quantityInput.value;
    });

    document.getElementById("decrease").addEventListener("click", function() {
        if (parseInt(quantityInput.value) > 1) {
            quantityInput.value = parseInt(quantityInput.value) - 1;
            if (selectedQuantityInput) selectedQuantityInput.value = quantityInput.value;
        }
    });

    // Update quantity hidden field when input changes
    quantityInput.addEventListener("change", function() {
        if (selectedQuantityInput) selectedQuantityInput.value = this.value;
    });

    // Initial call to set default price
    updatePriceDisplay();

    // Add event listener for price selection changes
    select.addEventListener('change', updatePriceDisplay);
});
</script>

{% endblock %}